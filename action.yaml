---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# sonarqube-cloud-scan-action
name: 'ðŸ” SonarCube Cloud Scan'
description: 'Performs a SonarQube Cloud scan and uploads the results'

# yamllint disable rule:line-length

# See: https://docs.sonarsource.com/sonarqube-server/latest/project-administration/analysis-scope/
# Create a file at the top of the repository called:
#   sonar-project.properties
# e.g. For Python projects, define directories for source code and tests:
# sonar.sources = src/
# sonar.tests = test/

inputs:
  # Mandatory
  sonar_token:
    description: 'SonarQube API key/token'
    required: true
  # Optional
  no_checkout:
    description: 'Do not checkout local repository; used for testing'
    required: false
    default: 'false'
  sonar_root_cert:
    description: 'Server root certificate PEM encoded'
    required: false
  build_wrapper_url:
    # e.g. https://raw.githubusercontent.com/o-ran-sc/ci-management/refs/heads/master/jjb/com-golog/prescan-golog-go-ubuntu.sh
    description: 'Download location of build wrapper/script'
    required: false
  build_wrapper_out_dir:
    description: 'Filesystem location of build outputs'
    required: false
  sonar_host_url:
    description: 'Uploads scans to the given host URL'
    required: false
    default: 'https://sonarcloud.io'
  lc_all:
    description: 'Change when code character set is outside the range of en_US.UTF-8'
    required: false
    default: "en_US.UTF-8"
  debug:
    description: 'Enable debugging output'
    required: false
    default: 'false'
  github_token:
    description: 'GitHub token for API access (optional, improves metadata accuracy)'
    required: false
    default: ''
  project_base_dir:
    description: 'Set the sonar.projectBaseDir analysis property'
    required: false
    default: '.'
  scanner_version:
    description: 'Version of the Sonar Scanner CLI to use'
    required: false
  args:
    description: 'Arguments to pass to the Sonar Scanner CLI (e.g., "-Dsonar.verbose=true")'
    required: false
    default: '-Dsonar.scanner.cache.enabled=false'

outputs:
  sonar_org:
    description: 'SonarQube organization'
    value: ${{ steps.sonar-config.outputs.sonar_org }}
  project_key:
    description: 'SonarQube project key'
    value: ${{ steps.sonar-config.outputs.project_key }}
  config_file:
    description: 'Path to SonarQube configuration file'
    value: ${{ steps.sonar-config.outputs.config_file }}

runs:
  using: 'composite'
  steps:
    - name: 'Checkout repository'
      if: inputs.no_checkout != 'true'
      uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      with:
        # Disabling shallow clones recommended to improve reporting accuracy
        fetch-depth: 0

    - name: 'Repository metadata'
      id: repository-metadata
      uses: lfreleng-actions/repository-metadata-action@8462ed1e666c78ae4b48667aa2fbc6101ed0a542 # v0.1.1
      with:
        github_token: ${{ inputs.github_token }}

    - name: 'Process SonarQube configuration'
      id: sonar-config
      shell: bash
      run: |
        # Process SonarQube configuration
        SONAR_PROPS="${{ inputs.project_base_dir }}/sonar-project.properties"
        SONARCLOUD_PROPS="${{ inputs.project_base_dir }}/.sonarcloud.properties"
        CONFIG_FILE=""

        if [ -f "$SONAR_PROPS" ]; then
          CONFIG_FILE="$SONAR_PROPS"
        elif [ -f "$SONARCLOUD_PROPS" ]; then
          CONFIG_FILE="$SONARCLOUD_PROPS"
        fi

        # If no config file exists, create ephemeral one
        if [ -z "$CONFIG_FILE" ]; then
          echo 'âš ï¸ Repository is missing a SonarQube configuration file'
          echo 'https://docs.sonarsource.com/sonarqube-cloud/advanced-setup/analysis-parameters/'
          echo '### âš ï¸ Repository is missing a SonarQube configuration file' >> "$GITHUB_STEP_SUMMARY"
          echo 'https://docs.sonarsource.com/sonarqube-cloud/advanced-setup/analysis-parameters/' >> "$GITHUB_STEP_SUMMARY"

          CONFIG_FILE="$SONAR_PROPS"
          mkdir -p "$(dirname "$CONFIG_FILE")"
          cat > "$CONFIG_FILE" <<EOF
        sonar.organization=${{ steps.repository-metadata.outputs.repository_owner }}
        sonar.projectKey=${{ steps.repository-metadata.outputs.repository_name }}
        sonar.scm.exclusions.disabled=true
        EOF
          echo "Created: $CONFIG_FILE"
        else
          echo 'SonarQube configuration present âœ…'
          echo '### SonarQube configuration present âœ…' >> "$GITHUB_STEP_SUMMARY"
        fi

        # Set config_file as step output after potential file creation
        echo "config_file=$CONFIG_FILE" >> "$GITHUB_OUTPUT"

        # Extract and output configuration values (strip whitespace and quotes)
        SONAR_ORG=$(grep -E "^sonar.organization=" "$CONFIG_FILE" | cut -d'=' -f2- | xargs || echo "")
        SONAR_PROJECT_KEY=$(grep -E "^sonar.projectKey=" "$CONFIG_FILE" | cut -d'=' -f2- | xargs || echo "")

        echo "sonar_org=$SONAR_ORG" >> "$GITHUB_OUTPUT"
        echo "project_key=$SONAR_PROJECT_KEY" >> "$GITHUB_OUTPUT"

        if [ -n "$SONAR_ORG" ]; then
          echo "- **Organization**: $SONAR_ORG" >> "$GITHUB_STEP_SUMMARY"
        fi

        if [ -n "$SONAR_PROJECT_KEY" ]; then
          echo "- **Project Key**: $SONAR_PROJECT_KEY" >> "$GITHUB_STEP_SUMMARY"
        fi

    - name: 'Download remote build script'
      if: inputs.build_wrapper_url != ''

      uses: lfreleng-actions/url-download-action@ece51fd0f08fd2db2eda53b1acd06c4747336c16 # v0.1.3
      with:
        url: ${{ inputs.build_wrapper_url }}

    - name: 'Validate required input parameters'
      if: inputs.build_wrapper_url != ''
      shell: bash
      run: |
        # Validate required input parameters
        if [ -z "${{ inputs.build_wrapper_out_dir }}" ]; then
          echo 'Error: build outputs directory must be specified when using a build wrapper âŒ'
          exit 1
        fi

    - name: 'Install build wrapper'
      if: inputs.build_wrapper_url != ''

      uses: SonarSource/sonarqube-scan-action/install-build-wrapper@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0

    - name: 'Run build wrapper'
      if: inputs.build_wrapper_url != ''
      shell: bash
      run: |
        # Run build wrapper ðŸ§±
        BUILD_SCRIPT="./$(basename ${{ inputs.build_wrapper_url }})"
        BUILD_WRAPPER_OUT_DIR="${{ inputs.build_wrapper_out_dir }}"
        chmod u+x "$BUILD_SCRIPT"
        if [ ! -d "$BUILD_WRAPPER_OUT_DIR" ]; then
          mkdir -p "$BUILD_WRAPPER_OUT_DIR"
          echo "Created build wrapper output directory: $BUILD_WRAPPER_OUT_DIR"
        fi
        echo "Running: build-wrapper-linux-x86-64 --out-dir $BUILD_WRAPPER_OUT_DIR $BUILD_SCRIPT"
        build-wrapper-linux-x86-64 --out-dir "$BUILD_WRAPPER_OUT_DIR" "$BUILD_SCRIPT"

    - name: 'Debug action/environment'
      if: inputs.debug == 'true'
      shell: bash
      run: |
        # Debug action/environment
        CONFIG_FILE="${{ steps.sonar-config.outputs.config_file }}"
        echo "Debug logging enabled ðŸž"
        echo "Current directory: $(pwd)"
        echo "GitHub workspace: ${{ github.workspace }}"
        echo "Project base dir: ${{ inputs.project_base_dir }}"
        if [ -n "$CONFIG_FILE" ]; then
          echo "Scan configuration file: $CONFIG_FILE"
        fi
        echo "Directory content (workspace root):"
        ls -la
        if [ "${{ inputs.project_base_dir }}" != "." ]; then
          echo ""
          echo "Directory content (project base dir):"
          ls -la "${{ inputs.project_base_dir }}" || echo "Project base dir not found"
        fi

    - name: 'SonarQube Scan'
      id: sonar-scan

      uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
        SONAR_HOST_URL: ${{ inputs.sonar_host_url }}
        SONAR_ROOT_CERT: ${{ inputs.sonar_root_cert }}
        SONAR_VERBOSE: ${{ inputs.debug }}
        LC_ALL: ${{ inputs.lc_all }}
        SONAR_SCANNER_OPTS: "-Dsonar.scanner.skipJreProvisioning=true"
      with:
        projectBaseDir: ${{ inputs.project_base_dir }}
        scannerVersion: ${{ inputs.scanner_version || '7.2.0.5079' }}
        args: ${{ inputs.args }}

    - name: 'Parse scan output'
      id: parse-output
      shell: bash
      run: |
        # Parse scan output
        REPORT_TASK_FILE="${{ inputs.project_base_dir }}/.scannerwork/report-task.txt"

        if [ -f "$REPORT_TASK_FILE" ]; then
          echo "Scanner report task file found ðŸ“"
        else
          echo "Scanner report task file not found ðŸš«"
        fi

        # Check for NOT_BOUND in report-task.txt
        if [ -f "$REPORT_TASK_FILE" ] && grep -q "NOT_BOUND" "$REPORT_TASK_FILE"; then
          echo "not_bound=true" >> "$GITHUB_OUTPUT"
        else
          echo "not_bound=false" >> "$GITHUB_OUTPUT"
        fi

        # Output report file path for reuse in subsequent steps
        echo "report_task_file=$REPORT_TASK_FILE" >> "$GITHUB_OUTPUT"

    - name: 'Print summary/job output'
      shell: bash
      # yamllint disable rule:line-length
      run: |
        # Print summary/job output
        # Extract the dashboard URL from .scannerwork/report-task.txt if available
        DEBUG_MODE="${{ inputs.debug }}"
        DASHBOARD_URL=""
        REPORT_TASK_FILE="${{ steps.parse-output.outputs.report_task_file }}"

        # Extract PROJECT_KEY early so it's available for NOT_BOUND warning
        PROJECT_KEY="${{ steps.sonar-config.outputs.project_key }}"

        # Extract dashboard URL from report-task.txt
        if [ -f "$REPORT_TASK_FILE" ]; then
          DASHBOARD_URL=$(grep -E "^dashboardUrl=" "$REPORT_TASK_FILE" | cut -d'=' -f2-)
        fi

        # Fallback to constructing URL if not found in report-task.txt
        if [ -z "$DASHBOARD_URL" ]; then
          if [ -n "$PROJECT_KEY" ]; then
            DASHBOARD_URL="https://sonarcloud.io/dashboard?id=${PROJECT_KEY}"
          else
            # Last resort: use repository metadata
            DASHBOARD_URL="https://sonarcloud.io/project/overview?id=${{ steps.repository-metadata.outputs.repository_owner }}_${{ steps.repository-metadata.outputs.repository_name }}"
          fi
        fi

        # Debug output consolidated in one code block
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "Debug: Checking for report-task.txt at: $REPORT_TASK_FILE"
          if [ -f "$REPORT_TASK_FILE" ]; then
            echo "Debug: report-task.txt found, contents:"
            cat "$REPORT_TASK_FILE"
          else
            echo "Debug: report-task.txt not found"
          fi
          echo "Debug: PROJECT_KEY=$PROJECT_KEY"
          echo "Debug: Final dashboard URL: $DASHBOARD_URL"
        fi

        echo '## ðŸ” SonarQube Cloud Scan Results Updated' >> "$GITHUB_STEP_SUMMARY"
        echo "ðŸ”— ${DASHBOARD_URL}" >> "$GITHUB_STEP_SUMMARY"

        # Check for NOT_BOUND condition
        if [ "${{ steps.parse-output.outputs.not_bound }}" = "true" ]; then
          echo "âš ï¸ WARNING: Project is NOT_BOUND to GitHub repository"
          echo "### âš ï¸ Project Binding Warning" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "The SonarCloud project exists in SonarCloud but is not linked to your GitHub repository." >> "$GITHUB_STEP_SUMMARY"
          echo "See: https://docs.sonarsource.com/sonarqube-cloud/getting-started/github" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
        fi
